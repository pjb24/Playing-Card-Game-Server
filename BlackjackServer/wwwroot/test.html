<!DOCTYPE html>
<html>
    <head>
        <title>Blackjack Test Client</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js" integrity="sha512-7SRCYIJtR6F8ocwW7UxW6wGKqbSyqREDbfCORCbGLatU0iugBLwyOXpzhkPyHIFdBO0K2VCu57fvP2Twgx1o2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>
    <body>
        <h2>Blackjack Test</h2>
        <input type="text" id="userName" placeholder="Enter your name" />
        <button id="joinButton" onclick="joinGame()">Join Game</button>

        <button id="startGameButton" onclick="startGame()">Start Game </button>

        <input type="number" id="betAmount" placeholder="Enter Bet Amount" />
        <button id="betButton" onclick="placeBet()">Place Bet</button>

        <button id="leaveButton" onclick="leaveGame()">Leave Game</button>


        <div id="gameArea" style="display:none;">
            <h3>Game Area</h3>
            <div id="gameStatus"></div>
            <button id="hitButton" onclick="hit()">Hit</button>
            <button id="standButton" onclick="stand()">Stand</button>
            <button id="splitButton" onclick="split()">Split</button>
            <button id="doubleButton" onclick="doubleDown()">Double Down</button>
            <button id="leaveButton">Leave Game</button>
            <div id="playerCards"></div>
            <div id="dealerCards"></div>
            <div id="chips"></div>
        </div>
        

        <script>
            const CommandDispatcher = {
                handlers: {},

                register(commandName, handler) {
                    this.handlers[commandName] = handler;
                },

                dispatch(commandName, payload) {
                    const handler = this.handlers[commandName];
                    if (handler) {
                        console.log(`[Dispatcher] 실행할 명령: ${commandName}`);
                        handler(payload);
                    } else {
                        console.warn(`[Dispatcher] 알 수 없는 명령: ${commandName}`);
                    }
                }
            };

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/blackjackHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            let currentHandId = null;
            let playerGuid = null;


            // Connection event handlers
            CommandDispatcher.register("Welcome", (args) => {
                const obj = JSON.parse(args);
                log(obj.message);
            });
            CommandDispatcher.register("UserConnected", (args) => {
                const obj = JSON.parse(args);
                log(`User connected: ${obj.message}`);
            });
            CommandDispatcher.register("UserDisconnected", (args) => {
                const obj = JSON.parse(args);
                log(`User disconnected: ${obj.message}`);
            });
            CommandDispatcher.register("OnError", (args) => {
                const obj = JSON.parse(args);
                log(`Error: ${obj.message}`);
            });


            // Player Join/Leave
            CommandDispatcher.register("OnJoinSuccess", (args) => {
                const obj = JSON.parse(args);
                log(`Joined as Name: ${obj.userName}, Guid: ${obj.playerGuid}`);
                document.getElementById("gameArea").style.display = "block";
                document.getElementById("joinButton").style.display = "none";

                playerGuid = obj.playerGuid;

                document.getElementById("hitButton").disabled = true;
                document.getElementById("standButton").disabled = true;
                document.getElementById("splitButton").disabled = true;
                document.getElementById("doubleButton").disabled = true;
            });
            CommandDispatcher.register("OnUserJoined", (args) => {
                const obj = JSON.parse(args);
                log(`${obj.userName} has joined the game.`);
            });
            CommandDispatcher.register("OnUserLeft", (args) => {
                const obj = JSON.parse(args);
                log(`${obj.connectionId} has left the game.`);
            });

            // Player Remain Chips
            CommandDispatcher.register("OnPlayerRemainChips", (args) => {
                const obj = JSON.parse(args);
                const playerChips = document.getElementById("chips");
                playerChips.innerHTML = `<p>RemainChips: ${obj.chips}</p>`;
            });

            CommandDispatcher.register("OnGameStateChanged", (args) => {
                const obj = JSON.parse(args);
                log(`Game state changed to: ${obj.state}`);
                // Update UI based on game state
            });


            // Betting State
            CommandDispatcher.register("OnTimeToBetting", (args) => {
                const obj = JSON.parse(args);
                log(`Hand: ${obj.handId} needs to place a bet.`);
                currentHandId = obj.handId;
            });
            CommandDispatcher.register("OnBetPlaced", (args) => {
                const obj = JSON.parse(args);
                log(`Player ${obj.playerName}, Hand: ${obj.handId} Bet placed: ${obj.betAmount}`);
            });


            // Dealing State
            CommandDispatcher.register("OnCardDealt", (args) => {
                const obj = JSON.parse(args);
                log(`Card dealt to PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName}: ${obj.cardString}. Hand: ${obj.handId}`);
            });
            CommandDispatcher.register("OnDealerCardDealt", (args) => {
                const obj = JSON.parse(args);
                log(`Dealer card dealt: ${obj.cardString}`);
                const dealerCards = document.getElementById("dealerCards");
                dealerCards.innerHTML += `<p></p>`;
            });
            CommandDispatcher.register("OnDealerHiddenCardDealt", (args) => {
                const obj = JSON.parse(args);
                log("Dealer's hidden card dealt.");
            });
            

            // PlayerTurn State
            CommandDispatcher.register("OnTimeToAction", (args) => {
                const obj = JSON.parse(args);
                log(`PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName}, Hand: ${obj.handId}. Choose an action.`);
                
                if (playerGuid !== obj.playerGuid) {
                    log(`It's not your turn! Waiting for PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName}.`);

                    document.getElementById("hitButton").disabled = true;
                    document.getElementById("standButton").disabled = true;
                    document.getElementById("splitButton").disabled = true;
                    document.getElementById("doubleButton").disabled = true;

                    return;
                }

                currentHandId = obj.handId;

                document.getElementById("hitButton").disabled = false;
                document.getElementById("standButton").disabled = false;
                document.getElementById("splitButton").disabled = false;
                document.getElementById("doubleButton").disabled = false;
            });
            CommandDispatcher.register("OnPlayerBusted", (args) => {
                const obj = JSON.parse(args);
                log(`PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName} has busted with hand: ${obj.handId}.`);
            });
            CommandDispatcher.register("OnActionDone", (args) => {
                const obj = JSON.parse(args);
                log(`PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName} has completed their action with hand: ${obj.handId}.`);
            });
            CommandDispatcher.register("OnHandSplit", (args) => {
                const obj = JSON.parse(args);
                log(`PlayerName: ${obj.playerName}, Split From Hand: ${obj.handId}, To Hand: ${obj.newHandId}`);
            });

            // DealerTurn State
            CommandDispatcher.register("OnDealerHoleCardRevealed", (args) => {
                const obj = JSON.parse(args);
                log(`Dealer's hole card revealed: ${obj.cardString}`);
            });


            // Result State
            CommandDispatcher.register("OnHandEvaluation", (args) => {
                const obj = JSON.parse(args);
                log(`Hand evaluation for PlayerGuid: ${obj.playerGuid}, PlayerName: ${obj.playerName}: HandId: ${obj.handId}. Result: ${obj.evaluationResult}`);
            });
            CommandDispatcher.register("OnPayout", (args) => {
                const obj = JSON.parse(args);
                log(`Payout for Hand: ${obj.handId}, Result: ${obj.evaluationResult}`);
            });


            connection.on("ReceiveCommand", (commandName, payload) => {
                CommandDispatcher.dispatch(commandName, payload);
            });


            async function joinGame() {
                const name = document.getElementById("userName").value;
                try {
                    const payload = {
                        userName: name
                    };
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "JoinGame", jsonString);
                } catch (err) {
                    console.log(`Error join game: ${err.toString()}`);
                    log(`Error join game: ${err.toString()}`);
                }
            }

            async function startGame() {
                try {
                    const playerCards = document.getElementById("playerCards");
                    playerCards.innerHTML = ``;
                    const dealerCards = document.getElementById("dealerCards");
                    dealerCards.innerHTML = ``;
                    await connection.invoke("ExecuteCommand", "StartGame", "");
                } catch (err) {
                    log(`Error start game: ${err.toString()}`);
                }
            }

            async function placeBet() {
                const betAmount = parseInt(document.getElementById("betAmount").value);
                if (isNaN(betAmount) || betAmount <= 0) {
                    log("Please enter a valid bet amount.");
                    return;
                }
                try {
                    const payload = {
                        amount: betAmount,
                        handId: currentHandId
                    };
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "PlaceBet", jsonString);
                } catch (err) {
                    log(`Error place bet: ${err.toString()}`);
                }
            }

            async function leaveGame() {
                try {
                    await connectin.invoke("LeaveGame");
                } catch (err) {
                    log(`Error leave game: ${err.toString()}`);
                }
            }

            async function hit() {
                try {
                    const payload = {
                        handId: currentHandId
                    }
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "Hit", jsonString);
                } catch (err) {
                    log(`Error hit: ${err.toString()}`);
                }
            }

            async function stand() {
                try {
                    const payload = {
                        handId: currentHandId
                    }
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "Stand", jsonString);
                } catch (err) {
                    log(`Error stand: ${err.toString()}`);
                }
            }

            async function split() {
                try {
                    const payload = {
                        handId: currentHandId
                    }
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "Split", jsonString);
                } catch (err) {
                    log(`Error split: ${err.toString()}`);
                }
            }

            async function doubleDown() {
                try {
                    const payload = {
                        handId: currentHandId
                    }
                    const jsonString = JSON.stringify(payload);
                    await connection.invoke("ExecuteCommand", "DoubleDown", jsonString);
                } catch (err) {
                    log(`Error double down: ${err.toString()}`);
                }
            }

            function log(message) {
                const gameStatus = document.getElementById("gameStatus");
                gameStatus.innerHTML += `<p>${message}</p>`;
                window.scrollTo(0, document.body.scrollHeight);
            }

            connection.start().then(() => {
                log("Connected to server");
            });
        </script>
    </body>
</html>